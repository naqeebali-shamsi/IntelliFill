# syntax=docker/dockerfile:1.4
# IntelliFill Backend Test Dockerfile
# Optimized for fast test runs with BuildKit caching

FROM node:20-alpine AS test

# Install system dependencies
RUN apk add --no-cache python3 make g++ curl bash cairo-dev jpeg-dev pango-dev giflib-dev

WORKDIR /app

# Copy package files first for better caching
COPY package.json package-lock.json ./

# Install all dependencies with cache mount
RUN --mount=type=cache,target=/root/.npm,sharing=locked \
    npm ci --ignore-scripts

# Copy Prisma schema and generate client
COPY prisma ./prisma/
RUN npx prisma generate

# Copy config files
COPY tsconfig.json jest.config.js* ./

# Copy source code
COPY src ./src/

# Copy tests
COPY tests ./tests/

# Build application (optional for tests, but validates TypeScript)
RUN npm run build || true

# Health check
HEALTHCHECK --interval=5s --timeout=3s --start-period=10s --retries=3 \
  CMD curl -f http://localhost:3001/health || exit 1

# Default test command
CMD ["npm", "test"]
