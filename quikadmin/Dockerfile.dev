# syntax=docker/dockerfile:1.4
# IntelliFill Backend Development Dockerfile
# Optimized for fast rebuilds with BuildKit caching

FROM node:20-alpine

# Install build tools for native dependencies (sharp, tensorflow, etc.)
RUN apk add --no-cache python3 make g++ cairo-dev jpeg-dev pango-dev giflib-dev

WORKDIR /app

# Create non-root user for security
RUN addgroup -g 1001 -S appgroup && \
    adduser -u 1001 -S appuser -G appgroup

# Copy package files first (changes less frequently = better caching)
COPY --chown=appuser:appgroup package.json package-lock.json ./

# Install dependencies with BuildKit cache mount
# Cache npm downloads and node_modules across builds
RUN --mount=type=cache,target=/root/.npm,sharing=locked \
    npm ci --ignore-scripts && \
    npm cache clean --force

# Copy config files (changes occasionally)
COPY --chown=appuser:appgroup tsconfig.json nodemon.json ./

# Copy Prisma schema (needed for generate)
COPY --chown=appuser:appgroup prisma/schema.prisma ./prisma/

# Generate Prisma client
RUN npx prisma generate

# Create directories for mounted volumes
RUN mkdir -p src uploads outputs logs && chown -R appuser:appgroup .

# Switch to non-root user
USER appuser

# Expose app port and debug port
EXPOSE 3002 9229

# Default command (can be overridden in docker-compose)
CMD ["npm", "run", "dev"]
