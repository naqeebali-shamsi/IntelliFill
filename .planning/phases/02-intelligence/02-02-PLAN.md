---
phase: 02-intelligence
plan: 02
type: execute
wave: 2
depends_on: ['02-01']
files_modified:
  - quikadmin-web/src/components/smart-profile/PersonGrouper/index.tsx
  - quikadmin-web/src/components/smart-profile/PersonGrouper/PersonCard.tsx
  - quikadmin-web/src/components/smart-profile/PersonGrouper/DocumentItem.tsx
  - quikadmin-web/src/components/smart-profile/PersonGrouper/MergeSuggestion.tsx
  - quikadmin-web/src/components/smart-profile/index.ts
  - quikadmin-web/src/pages/SmartProfile.tsx
  - quikadmin-web/src/services/smartProfileService.ts
autonomous: true
---

<objective>
PersonGrouper UI with drag-drop document reassignment between person groups.

Purpose: Allow users to correct automatic person grouping by dragging documents between people. Handles the case where the AI grouped documents incorrectly (false merge or false split).

Output: PersonGrouper component integrated into the wizard, functional drag-drop between groups, merge suggestions visible.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-intelligence/02-RESEARCH.md
@.planning/phases/02-intelligence/02-01-SUMMARY.md

# Source files

@quikadmin-web/src/pages/SmartProfile.tsx
@quikadmin-web/src/stores/smartProfileStore.ts
@quikadmin-web/src/components/smart-profile/index.ts
@quikadmin-web/src/components/smart-profile/FileCard.tsx
@quikadmin-web/src/components/smart-profile/ConfidenceBadge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DocumentItem component (draggable document card)</name>
  <files>quikadmin-web/src/components/smart-profile/PersonGrouper/DocumentItem.tsx</files>
  <action>
Create the draggable document item using @dnd-kit/sortable.

Pattern from 02-RESEARCH.md code examples.

**DocumentItem.tsx:**

```typescript
interface DocumentItemProps {
  document: {
    id: string;
    fileName: string;
    detectedType: string | null;
    confidence: number;
  };
  isDragging?: boolean;
}
```

Implement using useSortable hook:

1. Call `useSortable({ id: document.id })`
2. Apply transform and transition styles via CSS.Transform.toString
3. Render: drag handle (GripVertical), file icon, file name, ConfidenceBadge
4. Add `aria-label` for accessibility: "Drag {fileName}"
5. Style: when dragging, add ring-2 ring-primary and opacity-50

Use semantic colors from existing patterns. Keep component simple - it's just a draggable card.
</action>
<verify>TypeScript compiles: `cd quikadmin-web && npx tsc --noEmit`</verify>
<done>

- DocumentItem.tsx created with useSortable hook
- Drag handle, file info, confidence badge rendered
- Proper ARIA labels for accessibility
- Drag state styling applied
  </done>
  </task>

<task type="auto">
  <name>Task 2: Create PersonCard component (droppable person container)</name>
  <files>quikadmin-web/src/components/smart-profile/PersonGrouper/PersonCard.tsx</files>
  <action>
Create the person group card that contains draggable documents.

**PersonCard.tsx:**

```typescript
interface PersonCardProps {
  group: {
    id: string;
    name: string | null;
    confidence: number;
    documentIds: string[];
  };
  documents: Array<{
    id: string;
    fileName: string;
    detectedType: string | null;
    confidence: number;
  }>;
  onRename?: (groupId: string, newName: string) => void;
}
```

Implement:

1. Card with header showing person name (or "Unknown Person") and document count
2. Editable name field (inline edit pattern)
3. Confidence badge for group
4. SortableContext wrapping document list with verticalListSortingStrategy
5. Map over documents, render DocumentItem for each
6. Empty state when no documents: "Drag documents here"

Use useDroppable for the container to detect when documents are dragged over.
</action>
<verify>TypeScript compiles</verify>
<done>

- PersonCard.tsx created with droppable container
- Inline name editing supported
- Documents rendered via DocumentItem
- Empty state shown when no documents
  </done>
  </task>

<task type="auto">
  <name>Task 3: Create PersonGrouper main component with DndContext</name>
  <files>
quikadmin-web/src/components/smart-profile/PersonGrouper/index.tsx,
quikadmin-web/src/components/smart-profile/PersonGrouper/MergeSuggestion.tsx
  </files>
  <action>
Create the main PersonGrouper orchestrating drag-drop between person cards.

**MergeSuggestion.tsx:**
Small component showing merge suggestions from backend:

```typescript
interface MergeSuggestionProps {
  groups: Array<{ id: string; name: string | null }>;
  confidence: number;
  reason: string;
  onMerge: () => void;
  onDismiss: () => void;
}
```

Render: "Did you mean to combine {name1} and {name2}? (85% match - similar names)" with Merge/Dismiss buttons.

**PersonGrouper/index.tsx:**

```typescript
interface PersonGrouperProps {
  groups: Array<{
    id: string;
    name: string | null;
    confidence: number;
    documentIds: string[];
  }>;
  documents: Array<{
    id: string;
    fileName: string;
    detectedType: string | null;
    confidence: number;
  }>;
  suggestedMerges?: Array<{
    groupIds: [string, string];
    confidence: number;
    reason: string;
  }>;
  onGroupingChange: (
    groups: Array<{ id: string; name: string | null; documentIds: string[] }>
  ) => void;
}
```

Implement:

1. Local state for groups (clone from props)
2. DndContext with PointerSensor and KeyboardSensor
3. Grid of PersonCard components (responsive: 1 col mobile, 2 tablet, 3 desktop)
4. DragOverlay showing DocumentItem when dragging
5. handleDragEnd: find source/target groups, move document ID between them, call onGroupingChange
6. "Merge All" button at bottom - combines all groups into one
7. "Create New Person" button - creates empty group for splitting
8. MergeSuggestion banners at top (dismissable)

Follow 02-RESEARCH.md pattern for handleDragEnd logic.
</action>
<verify>TypeScript compiles: `cd quikadmin-web && npx tsc --noEmit`</verify>
<done>

- PersonGrouper/index.tsx orchestrates drag-drop
- DndContext with sensors configured
- DragOverlay shows dragged document
- handleDragEnd moves documents between groups
- Merge All and Create New Person actions work
- MergeSuggestion component shows backend suggestions
  </done>
  </task>

<task type="auto">
  <name>Task 4: Wire PersonGrouper into SmartProfile wizard</name>
  <files>
quikadmin-web/src/components/smart-profile/index.ts,
quikadmin-web/src/pages/SmartProfile.tsx,
quikadmin-web/src/services/smartProfileService.ts
  </files>
  <action>
Integrate PersonGrouper into the wizard and connect to store.

**smart-profile/index.ts:**
Add export: `export { PersonGrouper } from './PersonGrouper';`

**smartProfileService.ts:**
Update extractBatch response handling to include detectedPeople and suggestedMerges from API.

**SmartProfile.tsx:**
Replace GroupingStepContent placeholder with real PersonGrouper:

1. Import PersonGrouper from smart-profile
2. In GroupingStepContent:
   - Get detectedPeople, uploadedFiles from store
   - Get suggestedMerges from extraction result (add to store if not there)
   - Map uploadedFiles to documents array for PersonGrouper
   - Render PersonGrouper with props
   - On grouping change, call setDetectedPeople to update store

3. Update handleNext extraction flow:
   - After successful extraction, check result.detectedPeople
   - If >1 person, go to 'grouping' step (don't skip)
   - If 1 person, skip to 'review' or 'profile' as before

4. Store updates:
   - Add suggestedMerges to state if needed
   - Update setDetectedPeople to handle grouping changes
     </action>
     <verify>

- `cd quikadmin-web && bun run build` succeeds
- Manual test: Upload 2 docs with different names, verify grouping step shows 2 PersonCards
- Drag document from one card to another, verify it moves
  </verify>
  <done>
- PersonGrouper exported from smart-profile/index.ts
- GroupingStepContent renders PersonGrouper (not placeholder)
- Drag-drop between groups functional
- Merge suggestions displayed
- Grouping changes saved to store
  </done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd quikadmin-web && bun run build` succeeds
- [ ] DocumentItem drags correctly (visual feedback)
- [ ] PersonCard accepts dropped documents
- [ ] PersonGrouper moves documents between groups
- [ ] Wizard shows grouping step when multiple people detected
- [ ] Grouping changes persist in store
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- PersonGrouper renders with detected groups
- Documents can be dragged between person cards
- Merge suggestions visible and actionable
- Grouping step integrated into wizard flow
  </success_criteria>

<output>
After completion, create `.planning/phases/02-intelligence/02-02-SUMMARY.md`
</output>
