---
phase: 02-intelligence
plan: 04
type: execute
wave: 3
depends_on: ['02-02', '02-03']
files_modified:
  - quikadmin-web/src/components/smart-profile/FieldSourceBadge.tsx
  - quikadmin-web/src/components/smart-profile/MissingFieldsAlert.tsx
  - quikadmin-web/src/components/smart-profile/ProfileView.tsx
  - quikadmin-web/src/pages/SmartProfile.tsx
  - quikadmin-web/src/lib/form-fields.ts
autonomous: false
---

<objective>
Enhanced field source tracking and missing field detection.

Purpose: Show users where each field value came from (which document, manual edit) and alert them to fields required by their target form that are missing from extracted data. This completes the intelligence layer of the Smart Profile flow.

Output: FieldSourceBadge on profile fields, MissingFieldsAlert component, visual verification of complete Phase 2 flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-intelligence/02-RESEARCH.md
@.planning/phases/02-intelligence/02-02-SUMMARY.md
@.planning/phases/02-intelligence/02-03-SUMMARY.md

# Source files

@quikadmin-web/src/pages/SmartProfile.tsx
@quikadmin-web/src/stores/smartProfileStore.ts
@quikadmin-web/src/components/smart-profile/ProfileView.tsx
@quikadmin-web/src/components/smart-profile/FieldSourcePill.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FieldSourceBadge component</name>
  <files>quikadmin-web/src/components/smart-profile/FieldSourceBadge.tsx</files>
  <action>
Create a component showing field provenance (source document or manual edit).

Pattern from 02-RESEARCH.md FieldSourceBadge example.

**FieldSourceBadge.tsx:**

```typescript
interface FieldSourceBadgeProps {
  source: {
    documentId: string;
    documentName: string;
    confidence: number;
    extractedAt: string;
    manuallyEdited?: boolean;
  };
  className?: string;
}
```

Implement:

1. Small inline badge with icon (Edit for manual, FileText for document)
2. Tooltip showing full details:
   - If manuallyEdited: "Manually edited"
   - If from document: "From: {documentName}", "Confidence: {X}%", "Extracted: {date}"
3. Subtle styling - should not distract from field values
4. Icon only by default, label on hover/focus

Use existing Tooltip component from ui/tooltip.
</action>
<verify>TypeScript compiles: `cd quikadmin-web && npx tsc --noEmit`</verify>
<done>

- FieldSourceBadge.tsx created
- Shows icon with tooltip
- Distinguishes manual edits from extractions
- Non-intrusive styling
  </done>
  </task>

<task type="auto">
  <name>Task 2: Create MissingFieldsAlert component</name>
  <files>
quikadmin-web/src/components/smart-profile/MissingFieldsAlert.tsx,
quikadmin-web/src/lib/form-fields.ts
  </files>
  <action>
Create component showing which fields are missing for the target form.

**lib/form-fields.ts:**
Define required fields for common form types:

```typescript
export const FORM_REQUIRED_FIELDS: Record<string, string[]> = {
  'visa-application': [
    'fullName',
    'passportNumber',
    'dateOfBirth',
    'nationality',
    'passportExpiry',
  ],
  'emirates-id': ['fullName', 'emiratesId', 'dateOfBirth', 'nationality'],
  'bank-account': ['fullName', 'emiratesId', 'address', 'phoneNumber'],
  // Add more as needed
};

export function getMissingFields(profileData: Record<string, unknown>, formType: string): string[] {
  const required = FORM_REQUIRED_FIELDS[formType] || [];
  return required.filter((field) => !profileData[field] || profileData[field] === '');
}

export function getFieldLabel(fieldName: string): string {
  // Convert camelCase to Title Case
  return fieldName
    .replace(/([A-Z])/g, ' $1')
    .replace(/^./, (s) => s.toUpperCase())
    .trim();
}
```

**MissingFieldsAlert.tsx:**

```typescript
interface MissingFieldsAlertProps {
  missingFields: string[];
  suggestedDocuments?: string[];
  onDismiss?: () => void;
}
```

Implement:

1. Alert banner with status-warning styling
2. Header: "{N} fields still needed for this form"
3. List of missing fields with human-readable labels
4. If suggestedDocuments provided: "To fill these fields, upload: {Passport, Bank Statement}"
5. Dismissable if user wants to proceed anyway
6. Show nothing if no missing fields

Group missing fields by document type that typically contains them (from research: Passport for nationality, Bank Statement for address, etc.).
</action>
<verify>TypeScript compiles</verify>
<done>

- form-fields.ts with FORM_REQUIRED_FIELDS and helper functions
- MissingFieldsAlert.tsx with warning banner
- Missing fields listed with suggested documents
- Dismissable for power users
  </done>
  </task>

<task type="auto">
  <name>Task 3: Integrate FieldSourceBadge into ProfileView</name>
  <files>quikadmin-web/src/components/smart-profile/ProfileView.tsx</files>
  <action>
Add FieldSourceBadge to each field in ProfileView.

**ProfileView.tsx updates:**

1. Import FieldSourceBadge
2. For each field rendered, show FieldSourceBadge next to the value
3. Position: inline after field value or in field row
4. Pass fieldSources[fieldName] as the source prop
5. Only show badge if source exists (some fields may not have sources)

The ProfileView already receives fieldSources as a prop - just need to render the badge.

Ensure badge doesn't break existing layout or EditableField functionality.
</action>
<verify>

- `cd quikadmin-web && bun run build` succeeds
- ProfileView shows source badges next to field values
  </verify>
  <done>
- FieldSourceBadge rendered for each field with source
- Badge positioned inline with field value
- Existing edit functionality preserved
  </done>
  </task>

<task type="auto">
  <name>Task 4: Add MissingFieldsAlert to profile step</name>
  <files>
quikadmin-web/src/pages/SmartProfile.tsx,
quikadmin-web/src/components/smart-profile/index.ts
  </files>
  <action>
Show missing fields alert when user is on profile step.

**smart-profile/index.ts:**
Add exports:

```typescript
export { FieldSourceBadge } from './FieldSourceBadge';
export { MissingFieldsAlert } from './MissingFieldsAlert';
```

**SmartProfile.tsx updates:**

1. Import MissingFieldsAlert and getMissingFields
2. In ProfileStepContent, before ProfileView:
   - Calculate missing fields based on a default form type (or selectedFormId if available)
   - If missingFields.length > 0, render MissingFieldsAlert
3. Track dismissed state to allow hiding alert

For now, use 'visa-application' as default form type for missing field detection. Phase 3 will add FormSuggester for proper form selection.
</action>
<verify>

- `cd quikadmin-web && bun run build` succeeds
- Profile step shows missing fields alert when fields are missing
  </verify>
  <done>
- MissingFieldsAlert rendered in profile step
- Missing fields calculated based on form requirements
- Alert dismissable by user
  </done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 2 Intelligence flow: PersonGrouper, ConfidenceReview, FieldSourceBadge, MissingFieldsAlert</what-built>
  <how-to-verify>
    1. Start backend: `cd quikadmin && npm run dev`
    2. Start frontend: `cd quikadmin-web && bun run dev`
    3. Navigate to: http://localhost:8080/smart-profile
    4. Upload 2+ documents with different names (e.g., passport and bank statement for different people)
    5. Verify: Grouping step appears with PersonGrouper showing 2 person cards
    6. Drag a document from one person to another - verify it moves
    7. Click Continue to review step
    8. If low confidence fields exist, verify ReviewField components shown
    9. Edit a field value and confirm
    10. Continue to profile step
    11. Verify: Field values show FieldSourceBadge icons
    12. Hover over a badge - verify tooltip shows source document
    13. Verify: MissingFieldsAlert shows if fields are missing
    14. Check: No console errors, smooth transitions between steps
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 2, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd quikadmin-web && bun run build` succeeds
- [ ] FieldSourceBadge shows on profile fields
- [ ] Tooltips show correct source information
- [ ] MissingFieldsAlert appears when fields missing
- [ ] Complete flow works: Upload → Grouping → Review → Profile
- [ ] User verification checkpoint passed
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- User approved visual/functional flow
- Phase 2: Intelligence complete
- Ready for Phase 3: Polish
  </success_criteria>

<output>
After completion, create `.planning/phases/02-intelligence/02-04-SUMMARY.md`
</output>
