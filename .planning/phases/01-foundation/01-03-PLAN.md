---
phase: 01-foundation
plan: 03
type: execute
---

<objective>
Create batch extraction endpoint that processes multiple documents and returns unified profile data.

Purpose: Extract fields from all uploaded documents in a single request, merge into profile structure.
Output: Working extract-batch API that returns profile data with field sources and confidence scores.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

**Codebase patterns:**
@quikadmin/src/api/client-documents.routes.ts (extractFieldsByCategory, mergeToClientProfile)
@quikadmin/src/services/ocrService.ts (OCR processing)

**Key decisions:**

- Reuse existing OCR service
- Return all fields with confidence scores
- Track which document each field came from (fieldSources)
- Low-confidence fields (< 85%) flagged for review
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create extract-batch endpoint</name>
  <files>quikadmin/src/api/smart-profile.routes.ts</files>
  <action>
Add POST /api/smart-profile/extract-batch endpoint:

1. Accept multipart/form-data with files[] and documentTypes[] (from detection step)
2. For each file:
   - Upload to temp storage or process in-memory
   - Call OCR service (existing processDocumentAsync or processDocumentSync)
   - Extract fields using extractFieldsByCategory() pattern
   - Track confidence per field

3. Merge all extracted data into unified profile object:

   ```typescript
   interface ExtractBatchResponse {
     profileData: Record<string, any>; // Merged fields
     fieldSources: Record<
       string,
       {
         documentId: string;
         documentName: string;
         confidence: number;
         extractedAt: string;
       }
     >;
     lowConfidenceFields: Array<{
       fieldName: string;
       value: any;
       confidence: number;
       documentName: string;
     }>;
     processingTime: number;
   }
   ```

4. For duplicate fields across documents:
   - Keep highest confidence value
   - Track all sources in fieldSources

5. Flag fields with confidence < 0.85 in lowConfidenceFields array

Reference extractFieldsByCategory() in client-documents.routes.ts:1152-1348.
DO NOT create new OCR processing - wrap existing services.
</action>
<verify>curl with test documents returns merged profile data</verify>
<done>Endpoint extracts from multiple docs, returns merged profile with sources</done>
</task>

<task type="auto">
  <name>Task 2: Create batch extraction service function</name>
  <files>quikadmin-web/src/services/smartProfileService.ts</files>
  <action>
Create frontend service for smart profile API:

1. Create smartProfileService with:
   - detectTypes(files: File[]): Promise<DetectionResult[]>
   - extractBatch(files: File[], documentTypes: string[]): Promise<ExtractBatchResponse>

2. Use existing API patterns from other services
3. Handle FormData for file uploads
4. Add proper error handling

Types:

```typescript
interface DetectionResult {
  fileId: string;
  fileName: string;
  detectedType: DocumentType;
  confidence: number;
}

type DocumentType = 'PASSPORT' | 'EMIRATES_ID' | 'DRIVERS_LICENSE' | 'BANK_STATEMENT' | 'OTHER';

interface ExtractBatchResponse {
  profileData: Record<string, any>;
  fieldSources: Record<string, FieldSource>;
  lowConfidenceFields: LowConfidenceField[];
  processingTime: number;
}
```

  </action>
  <verify>Service functions compile, can be imported in components</verify>
  <done>smartProfileService exports detectTypes and extractBatch functions</done>
</task>

<task type="auto">
  <name>Task 3: Wire extraction to wizard flow</name>
  <files>quikadmin-web/src/pages/SmartProfile.tsx</files>
  <action>
Update wizard to call extraction on Continue:

1. When user clicks Continue from upload step:
   - Show loading state
   - Call extractBatch with uploaded files
   - Store results in smartProfileStore
   - If lowConfidenceFields.length > 0: go to 'review' step
   - Else: skip review, go to 'profile' step

2. Add loading indicator during extraction
3. Handle extraction errors with toast notification
4. Store extractionResult in store for use by ProfileView

This implements the "auto-skip" pattern from RESEARCH.md - skip review step when all fields are high confidence.
</action>
<verify>Upload files → Click Continue → See extraction loading → Profile data appears in store</verify>
<done>Extraction runs on Continue, results stored, auto-skip logic works</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Backend: `npm run build` passes
- [ ] Frontend: `bun run build` passes
- [ ] Extract-batch endpoint processes multiple documents
- [ ] Profile data merged correctly (highest confidence wins)
- [ ] Low-confidence fields identified (<85%)
- [ ] Field sources tracked
- [ ] Frontend calls extraction on Continue
- [ ] Auto-skip works (high-confidence → skip review)
</verification>

<success_criteria>

- extract-batch endpoint returns merged profile with sources
- Frontend service calls API correctly
- Wizard triggers extraction on Continue
- Auto-skip review step when all fields high-confidence
- Low-confidence fields passed to review step
  </success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
