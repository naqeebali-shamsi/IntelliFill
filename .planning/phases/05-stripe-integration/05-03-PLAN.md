---
phase: 05-stripe-integration
plan: 03
type: execute
wave: 2
depends_on: ['05-01']
files_modified:
  - quikadmin-web/src/stores/subscriptionStore.ts
  - quikadmin-web/src/services/stripeService.ts
  - quikadmin-web/src/pages/Pricing.tsx
  - quikadmin-web/src/components/features/UpgradePrompt.tsx
  - quikadmin-web/src/components/features/SubscriptionSettings.tsx
  - quikadmin-web/src/App.tsx
autonomous: true
---

<objective>
Implement frontend subscription UI with pricing page, upgrade prompts, and subscription management.

Purpose: Provide users with a clean, simple path to subscribe to PRO and manage their subscription through Stripe's Customer Portal.

Output: Working pricing page at `/pricing`, upgrade prompts in PRO-gated features, and subscription management in settings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-stripe-integration/05-CONTEXT.md
@.planning/phases/05-stripe-integration/05-RESEARCH.md
@.planning/phases/05-stripe-integration/05-01-SUMMARY.md
@quikadmin-web/CLAUDE.md
@quikadmin-web/src/stores/backendAuthStore.ts
@quikadmin-web/src/services/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stripe service for frontend API calls</name>
  <files>quikadmin-web/src/services/stripeService.ts</files>
  <action>
    Create a service for Stripe-related API calls:

    ```typescript
    import { api } from './api';

    export interface SubscriptionStatus {
      isPro: boolean;
      status: string | null;
      currentPeriodEnd: string | null;
    }

    export interface CheckoutSessionResponse {
      sessionId: string;
      url: string;
    }

    export interface PortalSessionResponse {
      url: string;
    }

    export const stripeService = {
      /**
       * Get current subscription status
       */
      async getSubscriptionStatus(): Promise<SubscriptionStatus> {
        const response = await api.get<{ data: SubscriptionStatus }>(
          '/stripe/subscription-status'
        );
        return response.data.data;
      },

      /**
       * Create checkout session for PRO subscription
       * Returns the Stripe Checkout URL to redirect to
       */
      async createCheckoutSession(
        successUrl: string,
        cancelUrl: string
      ): Promise<CheckoutSessionResponse> {
        const response = await api.post<{ data: CheckoutSessionResponse }>(
          '/stripe/create-checkout-session',
          { successUrl, cancelUrl }
        );
        return response.data.data;
      },

      /**
       * Create customer portal session for billing management
       * Returns the Stripe Portal URL to redirect to
       */
      async createPortalSession(returnUrl: string): Promise<PortalSessionResponse> {
        const response = await api.post<{ data: PortalSessionResponse }>(
          '/stripe/create-portal-session',
          { returnUrl }
        );
        return response.data.data;
      },
    };
    ```

    This service wraps the backend Stripe endpoints with proper typing.
    Uses the existing api instance which handles auth tokens automatically.

  </action>
  <verify>TypeScript compiles: `cd quikadmin-web && bun run typecheck`</verify>
  <done>Stripe service created with checkout, portal, and status methods</done>
</task>

<task type="auto">
  <name>Task 2: Create subscription store with Zustand</name>
  <files>quikadmin-web/src/stores/subscriptionStore.ts</files>
  <action>
    Create a Zustand store for subscription state:

    ```typescript
    import { create } from 'zustand';
    import { immer } from 'zustand/middleware/immer';
    import { devtools } from 'zustand/middleware';
    import { stripeService, SubscriptionStatus } from '@/services/stripeService';

    interface SubscriptionState {
      // State
      isPro: boolean;
      status: string | null;
      currentPeriodEnd: Date | null;
      loading: boolean;
      error: string | null;
      initialized: boolean;

      // Actions
      fetchStatus: () => Promise<void>;
      redirectToCheckout: () => Promise<void>;
      redirectToPortal: () => Promise<void>;
      reset: () => void;
    }

    const initialState = {
      isPro: false,
      status: null,
      currentPeriodEnd: null,
      loading: false,
      error: null,
      initialized: false,
    };

    // Conditionally apply devtools in development only
    function applyDevtools<T>(middleware: T): T {
      if (import.meta.env.DEV) {
        return devtools(middleware as any, {
          name: 'IntelliFill Subscription Store',
        }) as T;
      }
      return middleware;
    }

    export const useSubscriptionStore = create<SubscriptionState>()(
      applyDevtools(
        immer((set, get) => ({
          ...initialState,

          fetchStatus: async () => {
            set({ loading: true, error: null });
            try {
              const status = await stripeService.getSubscriptionStatus();
              set({
                isPro: status.isPro,
                status: status.status,
                currentPeriodEnd: status.currentPeriodEnd
                  ? new Date(status.currentPeriodEnd)
                  : null,
                loading: false,
                initialized: true,
              });
            } catch (error) {
              set({
                error: 'Failed to fetch subscription status',
                loading: false,
                initialized: true,
              });
            }
          },

          redirectToCheckout: async () => {
            set({ loading: true, error: null });
            try {
              const successUrl = `${window.location.origin}/pricing?success=true`;
              const cancelUrl = `${window.location.origin}/pricing?canceled=true`;

              const { url } = await stripeService.createCheckoutSession(
                successUrl,
                cancelUrl
              );

              // Redirect to Stripe Checkout
              window.location.href = url;
            } catch (error) {
              set({
                error: 'Failed to start checkout',
                loading: false,
              });
            }
          },

          redirectToPortal: async () => {
            set({ loading: true, error: null });
            try {
              const returnUrl = `${window.location.origin}/settings`;

              const { url } = await stripeService.createPortalSession(returnUrl);

              // Redirect to Stripe Customer Portal
              window.location.href = url;
            } catch (error) {
              set({
                error: 'Failed to open billing portal',
                loading: false,
              });
            }
          },

          reset: () => set(initialState),
        }))
      )
    );

    // Hook for checking PRO access
    export const useIsPro = () => useSubscriptionStore((state) => state.isPro);

    // Hook for subscription actions
    export const useSubscriptionActions = () =>
      useSubscriptionStore((state) => ({
        fetchStatus: state.fetchStatus,
        redirectToCheckout: state.redirectToCheckout,
        redirectToPortal: state.redirectToPortal,
      }));
    ```

    Key features:
    - Tracks isPro status for feature gating
    - Handles checkout and portal redirects
    - Follows existing store patterns (immer, devtools)
    - Provides convenient hooks for components

  </action>
  <verify>TypeScript compiles: `bun run typecheck`</verify>
  <done>Subscription store created with status tracking and redirect actions</done>
</task>

<task type="auto">
  <name>Task 3: Create Pricing page component</name>
  <files>quikadmin-web/src/pages/Pricing.tsx</files>
  <action>
    Create a clean, minimal pricing page:

    ```typescript
    import { useEffect } from 'react';
    import { useSearchParams, useNavigate } from 'react-router-dom';
    import { Check } from 'lucide-react';
    import { Button } from '@/components/ui/button';
    import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
    import { useSubscriptionStore, useIsPro } from '@/stores/subscriptionStore';
    import { useAuthStore } from '@/stores/backendAuthStore';
    import { toast } from '@/lib/toast';

    const PRO_FEATURES = [
      'Unlimited document processing',
      'Client library with search',
      'Form usage analytics',
      'Priority support',
      'API access',
      'Batch processing',
    ];

    export default function Pricing() {
      const [searchParams] = useSearchParams();
      const navigate = useNavigate();
      const isAuthenticated = useAuthStore((state) => state.isAuthenticated);
      const isPro = useIsPro();
      const { loading, error, redirectToCheckout, fetchStatus } = useSubscriptionStore();

      // Handle success/cancel redirects from Stripe
      useEffect(() => {
        if (searchParams.get('success') === 'true') {
          toast.success('Welcome to PRO! Your subscription is now active.');
          // Refresh subscription status
          fetchStatus();
          // Clear query params
          navigate('/pricing', { replace: true });
        } else if (searchParams.get('canceled') === 'true') {
          toast.info('Checkout canceled. No charges were made.');
          navigate('/pricing', { replace: true });
        }
      }, [searchParams, fetchStatus, navigate]);

      // Fetch status on mount if authenticated
      useEffect(() => {
        if (isAuthenticated) {
          fetchStatus();
        }
      }, [isAuthenticated, fetchStatus]);

      const handleSubscribe = () => {
        if (!isAuthenticated) {
          // Redirect to login with return URL
          navigate('/login?redirect=/pricing');
          return;
        }
        redirectToCheckout();
      };

      return (
        <div className="container max-w-4xl py-16">
          <div className="text-center mb-12">
            <h1 className="text-4xl font-bold tracking-tight mb-4">
              Simple, transparent pricing
            </h1>
            <p className="text-lg text-muted-foreground">
              Unlock the full power of IntelliFill with PRO
            </p>
          </div>

          <div className="flex justify-center">
            <Card className="w-full max-w-md">
              <CardHeader className="text-center pb-2">
                <CardTitle className="text-2xl">PRO</CardTitle>
                <CardDescription>For professionals and teams</CardDescription>
              </CardHeader>
              <CardContent className="pt-4">
                <div className="text-center mb-6">
                  <span className="text-4xl font-bold">$19</span>
                  <span className="text-muted-foreground">/month</span>
                </div>

                <ul className="space-y-3 mb-8">
                  {PRO_FEATURES.map((feature) => (
                    <li key={feature} className="flex items-center gap-3">
                      <Check className="h-5 w-5 text-primary flex-shrink-0" />
                      <span>{feature}</span>
                    </li>
                  ))}
                </ul>

                {isPro ? (
                  <div className="text-center">
                    <div className="inline-flex items-center gap-2 px-4 py-2 bg-primary/10 text-primary rounded-full mb-4">
                      <Check className="h-4 w-4" />
                      <span className="font-medium">You're subscribed to PRO</span>
                    </div>
                    <Button
                      variant="outline"
                      className="w-full"
                      onClick={() => navigate('/settings')}
                    >
                      Manage Subscription
                    </Button>
                  </div>
                ) : (
                  <Button
                    className="w-full"
                    size="lg"
                    onClick={handleSubscribe}
                    disabled={loading}
                  >
                    {loading ? 'Loading...' : 'Subscribe to PRO'}
                  </Button>
                )}

                {error && (
                  <p className="text-sm text-destructive text-center mt-4">{error}</p>
                )}
              </CardContent>
            </Card>
          </div>

          <p className="text-center text-sm text-muted-foreground mt-8">
            Cancel anytime. Powered by Stripe for secure payments.
          </p>
        </div>
      );
    }
    ```

    Key features:
    - Single PRO plan (per CONTEXT.md vision)
    - Handles success/cancel query params from Stripe redirect
    - Shows "You're subscribed" state for existing PRO users
    - Redirects to login if not authenticated
    - Uses existing UI components (Button, Card)

  </action>
  <verify>TypeScript compiles, no lint errors</verify>
  <done>Pricing page created with single PRO plan and checkout flow</done>
</task>

<task type="auto">
  <name>Task 4: Create UpgradePrompt component for PRO feature gates</name>
  <files>quikadmin-web/src/components/features/UpgradePrompt.tsx</files>
  <action>
    Create a reusable upgrade prompt component:

    ```typescript
    import { useNavigate } from 'react-router-dom';
    import { Sparkles } from 'lucide-react';
    import { Button } from '@/components/ui/button';
    import { Card, CardContent } from '@/components/ui/card';

    interface UpgradePromptProps {
      feature: string;
      description?: string;
      className?: string;
    }

    /**
     * Display when a free user tries to access a PRO feature
     * Redirects to /pricing page
     */
    export function UpgradePrompt({
      feature,
      description,
      className = '',
    }: UpgradePromptProps) {
      const navigate = useNavigate();

      return (
        <Card className={`border-primary/20 bg-primary/5 ${className}`}>
          <CardContent className="flex flex-col items-center text-center py-8 px-6">
            <div className="h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center mb-4">
              <Sparkles className="h-6 w-6 text-primary" />
            </div>
            <h3 className="text-lg font-semibold mb-2">
              {feature} is a PRO feature
            </h3>
            <p className="text-muted-foreground mb-6 max-w-sm">
              {description || 'Upgrade to PRO to unlock this feature and more.'}
            </p>
            <Button onClick={() => navigate('/pricing')}>
              Upgrade to PRO
            </Button>
          </CardContent>
        </Card>
      );
    }

    /**
     * Hook to check PRO access and redirect if not
     * Use in page components that should be PRO-only
     */
    export function useRequirePro(redirectPath = '/pricing') {
      const navigate = useNavigate();
      const { isPro, initialized } = useSubscriptionStore((state) => ({
        isPro: state.isPro,
        initialized: state.initialized,
      }));

      useEffect(() => {
        if (initialized && !isPro) {
          navigate(redirectPath);
        }
      }, [initialized, isPro, navigate, redirectPath]);

      return { isPro, loading: !initialized };
    }
    ```

    Add necessary import at top:
    ```typescript
    import { useEffect } from 'react';
    import { useSubscriptionStore } from '@/stores/subscriptionStore';
    ```

    Usage in existing PRO-gated components:
    - Replace hardcoded PRO checks with `useIsPro()` hook
    - Use `<UpgradePrompt feature="Client Library" />` for inline prompts
    - Use `useRequirePro()` for full-page PRO requirements

  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>UpgradePrompt component and useRequirePro hook created</done>
</task>

<task type="auto">
  <name>Task 5: Create SubscriptionSettings component</name>
  <files>quikadmin-web/src/components/features/SubscriptionSettings.tsx</files>
  <action>
    Create subscription management component for settings page:

    ```typescript
    import { useEffect } from 'react';
    import { useNavigate } from 'react-router-dom';
    import { ExternalLink, CreditCard, Calendar } from 'lucide-react';
    import { Button } from '@/components/ui/button';
    import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
    import { useSubscriptionStore } from '@/stores/subscriptionStore';

    /**
     * Subscription management section for Settings page
     * Shows current status and link to Stripe Customer Portal
     */
    export function SubscriptionSettings() {
      const {
        isPro,
        status,
        currentPeriodEnd,
        loading,
        error,
        fetchStatus,
        redirectToPortal,
      } = useSubscriptionStore();
      const navigate = useNavigate();

      useEffect(() => {
        fetchStatus();
      }, [fetchStatus]);

      const formatDate = (date: Date | null) => {
        if (!date) return 'N/A';
        return new Intl.DateTimeFormat('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        }).format(date);
      };

      const getStatusBadge = () => {
        if (!status) return null;

        const statusStyles: Record<string, string> = {
          active: 'bg-status-success/10 text-status-success',
          trialing: 'bg-status-pending/10 text-status-pending',
          past_due: 'bg-status-warning/10 text-status-warning',
          canceled: 'bg-muted text-muted-foreground',
        };

        const style = statusStyles[status] || 'bg-muted text-muted-foreground';

        return (
          <span className={`px-2 py-1 rounded-full text-xs font-medium ${style}`}>
            {status.charAt(0).toUpperCase() + status.slice(1).replace('_', ' ')}
          </span>
        );
      };

      return (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <CreditCard className="h-5 w-5" />
              Subscription
            </CardTitle>
            <CardDescription>
              Manage your IntelliFill PRO subscription
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            {loading ? (
              <div className="animate-pulse space-y-2">
                <div className="h-4 bg-muted rounded w-1/3"></div>
                <div className="h-4 bg-muted rounded w-1/2"></div>
              </div>
            ) : isPro ? (
              <>
                <div className="flex items-center justify-between">
                  <span className="text-sm text-muted-foreground">Plan</span>
                  <div className="flex items-center gap-2">
                    <span className="font-medium">PRO</span>
                    {getStatusBadge()}
                  </div>
                </div>

                {currentPeriodEnd && (
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-muted-foreground flex items-center gap-1">
                      <Calendar className="h-4 w-4" />
                      {status === 'canceled' ? 'Access until' : 'Renews on'}
                    </span>
                    <span className="font-medium">{formatDate(currentPeriodEnd)}</span>
                  </div>
                )}

                <Button
                  variant="outline"
                  className="w-full mt-4"
                  onClick={redirectToPortal}
                  disabled={loading}
                >
                  <ExternalLink className="h-4 w-4 mr-2" />
                  Manage Billing
                </Button>

                <p className="text-xs text-muted-foreground text-center">
                  Update payment method, view invoices, or cancel subscription
                </p>
              </>
            ) : (
              <>
                <div className="flex items-center justify-between">
                  <span className="text-sm text-muted-foreground">Plan</span>
                  <span className="font-medium">Free</span>
                </div>

                <Button
                  className="w-full mt-4"
                  onClick={() => navigate('/pricing')}
                >
                  Upgrade to PRO
                </Button>
              </>
            )}

            {error && (
              <p className="text-sm text-destructive">{error}</p>
            )}
          </CardContent>
        </Card>
      );
    }
    ```

    This component:
    - Shows current subscription status with visual badge
    - Displays renewal/access date
    - Provides "Manage Billing" link to Stripe Portal
    - Shows upgrade CTA for free users
    - Uses semantic status colors from design tokens

  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>SubscriptionSettings component created for settings page</done>
</task>

<task type="auto">
  <name>Task 6: Add Pricing route to App.tsx</name>
  <files>quikadmin-web/src/App.tsx</files>
  <action>
    Add the /pricing route to the app router:

    1. Import the Pricing page:
    ```typescript
    import Pricing from '@/pages/Pricing';
    ```

    2. Add the route - it should be PUBLIC (not inside ProtectedRoute):
    ```typescript
    <Route path="/pricing" element={<Pricing />} />
    ```

    Place this with other public routes (login, register, etc.) so users can view pricing before logging in.

    The page handles authentication state internally - showing "Login to subscribe" when needed.

  </action>
  <verify>App compiles and /pricing route is accessible</verify>
  <done>Pricing route added to application router</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bun run build` succeeds in quikadmin-web/
- [ ] `bun run typecheck` passes
- [ ] /pricing page loads and displays PRO plan
- [ ] Subscription store fetches status on auth
- [ ] SubscriptionSettings shows correct state
- [ ] UpgradePrompt component renders properly
</verification>

<success_criteria>

- Pricing page shows single PRO plan with features list
- Checkout button creates session and redirects to Stripe
- Success/cancel query params handled with appropriate toasts
- Subscription status persisted in Zustand store
- Settings page shows subscription management
- Upgrade prompts available for PRO feature gates
  </success_criteria>

<output>
After completion, create `.planning/phases/05-stripe-integration/05-03-SUMMARY.md`
</output>
