---
phase: 05-stripe-integration
plan: 04
type: execute
wave: 3
depends_on: ['05-02', '05-03']
files_modified:
  - quikadmin-web/src/components/smart-profile/index.ts
autonomous: false
---

<objective>
Test the complete subscription flow end-to-end and verify instant PRO unlock works correctly.

Purpose: Validate that the entire Stripe integration works as expected - from clicking subscribe to getting PRO access instantly.

Output: Verified working subscription flow with instant unlock behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-stripe-integration/05-CONTEXT.md
@.planning/phases/05-stripe-integration/05-RESEARCH.md
@.planning/phases/05-stripe-integration/05-01-SUMMARY.md
@.planning/phases/05-stripe-integration/05-02-SUMMARY.md
@.planning/phases/05-stripe-integration/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update PRO feature gates to use real subscription status</name>
  <files>quikadmin-web/src/components/smart-profile/index.ts</files>
  <action>
    The existing PRO features are scaffolded with hardcoded checks. Update them to use the real subscription status:

    1. Find any components that check for PRO access (e.g., client library, form analytics, admin dashboard)
    2. Replace hardcoded `isPro = false` or `isPro = true` with `useIsPro()` hook
    3. Add import: `import { useIsPro } from '@/stores/subscriptionStore';`

    Example pattern to look for and update:
    ```typescript
    // BEFORE (scaffolded)
    const isPro = false; // TODO: Check real subscription

    // AFTER (real check)
    const isPro = useIsPro();
    ```

    Common locations to check:
    - Client library components
    - Form analytics components
    - Admin accuracy dashboard
    - Any component showing "PRO" badge or requiring PRO access

    If a component currently shows `<UpgradePrompt>` with hardcoded condition, update to use `useIsPro()`.

  </action>
  <verify>TypeScript compiles, no hardcoded isPro values remain</verify>
  <done>All PRO feature gates use real subscription status from store</done>
</task>

<task type="auto">
  <name>Task 2: Start local services for testing</name>
  <files>N/A</files>
  <action>
    Ensure all services are running for the integration test:

    1. Backend (if not already running):
    ```bash
    cd quikadmin && npm run dev
    ```

    2. Frontend (if not already running):
    ```bash
    cd quikadmin-web && bun run dev
    ```

    3. Stripe CLI webhook forwarding (in separate terminal):
    ```bash
    stripe listen --forward-to localhost:3002/api/stripe/webhook
    ```

    Note the webhook signing secret from the Stripe CLI output - it should match STRIPE_WEBHOOK_SECRET in .env.

    4. Verify services are healthy:
    - Backend health: curl http://localhost:3002/api/health
    - Frontend: Open http://localhost:8080
    - Stripe CLI shows "Ready!"

  </action>
  <verify>All three services running, Stripe CLI connected</verify>
  <done>Local development environment ready for testing</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Stripe subscription integration</what-built>
  <how-to-verify>
    **Test the full subscription flow:**

    1. **Open pricing page (logged out):**
       - Visit: http://localhost:8080/pricing
       - Verify: PRO plan displayed with features list
       - Click "Subscribe to PRO" → Should redirect to login

    2. **Login and view pricing:**
       - Login with a test account
       - Visit: http://localhost:8080/pricing
       - Verify: Shows "Subscribe to PRO" button (not "You're subscribed")

    3. **Complete checkout (use test card):**
       - Click "Subscribe to PRO"
       - Should redirect to Stripe Checkout
       - Use test card: 4242 4242 4242 4242
       - Expiry: Any future date
       - CVC: Any 3 digits
       - Complete payment

    4. **Verify instant unlock:**
       - After payment, redirected to /pricing?success=true
       - Toast shows "Welcome to PRO!"
       - Page now shows "You're subscribed to PRO"
       - Check Stripe CLI output - should show webhook received

    5. **Verify PRO access:**
       - Navigate to a PRO feature (client library, etc.)
       - Should have access (no upgrade prompt)

    6. **Test Customer Portal:**
       - Visit: http://localhost:8080/settings
       - Find "Subscription" section
       - Click "Manage Billing"
       - Should open Stripe Customer Portal
       - Verify: Can see subscription, payment method, invoices

    7. **Test cancellation flow (optional):**
       - In Customer Portal, click "Cancel plan"
       - Confirm cancellation
       - Return to app
       - Refresh subscription status
       - Should show "Canceled" status with access-until date

  </how-to-verify>
  <resume-signal>Type "verified" if all tests pass, or describe any issues found</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Fix any issues found during verification</name>
  <files>Various (based on issues)</files>
  <action>
    Based on the verification results, fix any issues discovered:

    Common issues and fixes:
    - **Webhook not received:** Check STRIPE_WEBHOOK_SECRET matches CLI output
    - **No instant unlock:** Verify webhook endpoint is receiving events, check server logs
    - **Checkout fails:** Check STRIPE_SECRET_KEY and STRIPE_PRO_PRICE_ID are correct
    - **Portal fails:** Ensure user has stripeCustomerId in database
    - **Status not updating:** Check fetchStatus is called after redirect

    If all tests pass, this task is a no-op.

  </action>
  <verify>All issues from verification are resolved</verify>
  <done>Integration working correctly or issues documented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Full checkout flow works with test card
- [ ] Webhook received and processes correctly
- [ ] User becomes PRO instantly after payment
- [ ] PRO features accessible after subscription
- [ ] Customer Portal opens and works
- [ ] Subscription status displays correctly in settings
</verification>

<success_criteria>

- **Instant unlock works:** Pay → Features work immediately (the non-negotiable from CONTEXT.md)
- Checkout flow completes without errors
- Webhook events update database correctly
- Customer Portal allows billing management
- PRO feature gates work based on real subscription status
  </success_criteria>

<output>
After completion, create `.planning/phases/05-stripe-integration/05-04-SUMMARY.md`
</output>
