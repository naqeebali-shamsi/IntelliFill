---
phase: 05-stripe-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - quikadmin/prisma/schema.prisma
  - quikadmin/.env
  - quikadmin-web/.env
autonomous: false
user_setup:
  - service: stripe
    why: 'Payment processing requires API keys and product configuration'
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: 'Stripe Dashboard → Developers → API keys → Secret key (sk_live_... or sk_test_...)'
      - name: STRIPE_WEBHOOK_SECRET
        source: 'Stripe Dashboard → Developers → Webhooks → Signing secret (whsec_...)'
      - name: STRIPE_PRO_PRICE_ID
        source: 'Stripe Dashboard → Products → IntelliFill PRO → Pricing → Price ID (price_...)'
      - name: VITE_STRIPE_PUBLISHABLE_KEY
        source: 'Stripe Dashboard → Developers → API keys → Publishable key (pk_live_... or pk_test_...)'
    account_setup:
      - url: 'https://dashboard.stripe.com/register'
        skip_if: 'Already have Stripe account (acct_1ShpfHEMhTxeOndp exists)'
    dashboard_config:
      - task: 'Create IntelliFill PRO product'
        location: 'Stripe Dashboard → Products → + Add product'
        details: 'Name: IntelliFill PRO, Type: Recurring, Price: $X/month'
      - task: 'Configure Customer Portal'
        location: 'Stripe Dashboard → Settings → Billing → Customer portal'
        details: 'Enable: Update payment methods, Cancel subscriptions, View invoices'
      - task: 'Create webhook endpoint'
        location: 'Stripe Dashboard → Developers → Webhooks → + Add endpoint'
        details: 'URL: https://[your-domain]/api/stripe/webhook, Events: checkout.session.completed, invoice.paid, invoice.payment_failed, customer.subscription.deleted, customer.subscription.updated'
    local_dev:
      - 'stripe login'
      - 'stripe listen --forward-to localhost:3002/api/stripe/webhook'
---

<objective>
Add Stripe subscription fields to database schema and configure Stripe environment.

Purpose: Establish the foundation for PRO subscription tracking by extending the User model with Stripe-specific fields and ensuring all API keys are configured.

Output: Updated Prisma schema with subscription fields, environment variables configured in both backend and frontend.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-stripe-integration/05-CONTEXT.md
@.planning/phases/05-stripe-integration/05-RESEARCH.md
@quikadmin/prisma/schema.prisma
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure Stripe account and retrieve API credentials</action>
  <instructions>
    Before I can proceed with code changes, you need to:

    1. **Create Stripe Product:**
       - Go to: https://dashboard.stripe.com/products
       - Click "+ Add product"
       - Name: "IntelliFill PRO"
       - Pricing: Add a recurring price (e.g., $19/month)
       - Save and note the Price ID (starts with price_)

    2. **Configure Customer Portal:**
       - Go to: https://dashboard.stripe.com/settings/billing/portal
       - Enable: Update payment methods, Cancel subscriptions, View invoices
       - Save

    3. **Set up Webhook (for production):**
       - Go to: https://dashboard.stripe.com/webhooks
       - "+ Add endpoint"
       - URL: https://your-domain.com/api/stripe/webhook
       - Events: checkout.session.completed, invoice.paid, invoice.payment_failed, customer.subscription.deleted, customer.subscription.updated
       - Note the Signing secret (starts with whsec_)

    4. **For local development:**
       - Install Stripe CLI: https://stripe.com/docs/stripe-cli
       - Run: `stripe login`
       - Run: `stripe listen --forward-to localhost:3002/api/stripe/webhook`
       - Note the webhook signing secret from CLI output

    5. **Gather these values:**
       - Secret Key (sk_test_... or sk_live_...)
       - Publishable Key (pk_test_... or pk_live_...)
       - Webhook Secret (whsec_...)
       - PRO Price ID (price_...)

  </instructions>
  <verification>User has all 4 values ready to configure</verification>
  <resume-signal>Type "ready" with the Price ID (I'll prompt for secrets separately for security)</resume-signal>
</task>

<task type="auto">
  <name>Task 1: Add Stripe subscription fields to User model</name>
  <files>quikadmin/prisma/schema.prisma</files>
  <action>
    Add Stripe-related fields to the User model in Prisma schema:

    ```prisma
    model User {
      // ... existing fields ...

      // Stripe subscription fields
      stripeCustomerId    String?   @unique @map("stripe_customer_id")
      subscriptionId      String?   @unique @map("subscription_id")
      subscriptionStatus  String?   @map("subscription_status")  // 'active', 'canceled', 'past_due', 'trialing', etc.
      currentPeriodEnd    DateTime? @map("current_period_end")   // When billing period ends

      // ... rest of model ...
    }
    ```

    Place these fields after the existing user profile fields (bio, jobTitle, phone) and before the relation fields.
    Add appropriate @map() decorators to use snake_case in the database.

    IMPORTANT: Do NOT add any enum types. Use String for subscriptionStatus to allow Stripe's various status values.

  </action>
  <verify>npx prisma validate passes without errors</verify>
  <done>User model has stripeCustomerId, subscriptionId, subscriptionStatus, currentPeriodEnd fields</done>
</task>

<task type="auto">
  <name>Task 2: Generate Prisma migration</name>
  <files>quikadmin/prisma/migrations/</files>
  <action>
    Run Prisma migration to add the new fields:

    ```bash
    cd quikadmin
    npx prisma migrate dev --name add_stripe_subscription_fields
    ```

    This creates a migration file and applies it to the database.
    If there are any existing users, the new fields will be NULL (which is correct for non-subscribers).

  </action>
  <verify>Migration completes successfully, `npx prisma generate` succeeds</verify>
  <done>Database schema updated with Stripe fields</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Add Stripe environment variables</action>
  <instructions>
    Add these environment variables to the appropriate .env files:

    **Backend (quikadmin/.env):**
    ```
    STRIPE_SECRET_KEY=sk_test_your_key_here
    STRIPE_WEBHOOK_SECRET=whsec_your_secret_here
    STRIPE_PRO_PRICE_ID=price_your_price_id_here
    ```

    **Frontend (quikadmin-web/.env):**
    ```
    VITE_STRIPE_PUBLISHABLE_KEY=pk_test_your_key_here
    VITE_STRIPE_PRO_PRICE_ID=price_your_price_id_here
    ```

    Note: Use test keys (sk_test_, pk_test_) for development.
    The frontend needs the Price ID to display correct pricing info.

  </instructions>
  <verification>
    I'll verify by checking that:
    - Backend can read STRIPE_SECRET_KEY
    - Frontend can read VITE_STRIPE_PUBLISHABLE_KEY
  </verification>
  <resume-signal>Type "configured" when environment variables are set</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx prisma validate` passes
- [ ] Migration applied successfully
- [ ] User model has 4 new Stripe fields
- [ ] Backend .env has STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, STRIPE_PRO_PRICE_ID
- [ ] Frontend .env has VITE_STRIPE_PUBLISHABLE_KEY, VITE_STRIPE_PRO_PRICE_ID
</verification>

<success_criteria>

- Database schema includes subscription tracking fields
- All Stripe API keys configured in environment
- Stripe product and price created in dashboard
- Customer Portal configured
- Webhook endpoint registered (or CLI running for local dev)
  </success_criteria>

<output>
After completion, create `.planning/phases/05-stripe-integration/05-01-SUMMARY.md`
</output>
